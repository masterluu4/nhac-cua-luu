<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Music Player No-Ads (V2)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 20px; background: #121212; color: #e0e0e0; margin: 0; }
        h2 { text-align: center; color: #03DAC6; margin-bottom: 5px; }
        .status-bar { font-size: 12px; text-align: center; color: #666; margin-bottom: 20px; font-style: italic; }
        input { width: 100%; padding: 12px; margin-bottom: 15px; background: #333; border: 1px solid #444; color: white; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        button { width: 100%; padding: 12px; background: #03DAC6; border: none; color: black; font-weight: bold; border-radius: 8px; font-size: 16px; cursor: pointer; }
        button:active { opacity: 0.8; }
        .result-item { padding: 15px; border-bottom: 1px solid #333; cursor: pointer; display: flex; align-items: center; justify-content: space-between; }
        .result-item:active { background: #333; }
        .duration { font-size: 12px; color: #888; }
        #player-controls { position: fixed; bottom: 0; left: 0; right: 0; background: #1f1f1f; padding: 15px; text-align: center; border-top: 1px solid #333; box-shadow: 0 -2px 10px rgba(0,0,0,0.5); z-index: 100; }
        audio { width: 100%; margin-top: 10px; outline: none; }
        #results { padding-bottom: 120px; } 
    </style>
</head>
<body>
    <h2>YouTube Audio V2</h2>
    <div id="server-status" class="status-bar">Sẵn sàng kết nối...</div>

    <input type="text" id="searchInput" placeholder="Nhập tên bài hát (VD: Nhạc thiền)...">
    <button onclick="searchMusic()">Tìm kiếm</button>
    <div id="results"></div>

    <div id="player-controls" style="display:none;">
        <div id="nowPlaying" style="font-weight:bold; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #03DAC6;">Đang tải...</div>
        <audio id="audioPlayer" controls loop autoplay></audio>
    </div>

    <script>
        // Danh sách các Server dự phòng (Nếu cái này chết sẽ tự thử cái kia)
        const API_LIST = [
            "https://pipedapi.kavin.rocks",
            "https://api.piped.privacydev.net",
            "https://pipedapi.drgns.space",
            "https://api.piped.projectsegfau.lt",
            "https://pipedapi.tokhmi.xyz"
        ];

        // Hàm thông minh: Tự động thử từng server cho đến khi thành công
        async function fetchSmart(endpoint) {
            const statusDiv = document.getElementById('server-status');
            
            for (let i = 0; i < API_LIST.length; i++) {
                const url = API_LIST[i] + endpoint;
                try {
                    statusDiv.innerText = `Đang thử server ${i+1}...`;
                    const res = await fetch(url);
                    if (res.ok) {
                        statusDiv.innerText = `Đã kết nối: Server ${i+1}`;
                        return await res.json();
                    }
                } catch (e) {
                    console.warn(`Server ${i+1} lỗi, đang chuyển server khác...`);
                }
            }
            statusDiv.innerText = "Tất cả server đều bận. Hãy thử lại sau 1 phút!";
            throw new Error("All APIs failed");
        }

        async function searchMusic() {
            const btn = document.querySelector('button');
            const originalText = btn.innerText;
            btn.innerText = "Đang quét...";
            btn.disabled = true;
            
            const query = document.getElementById('searchInput').value;
            const list = document.getElementById('results');
            list.innerHTML = '';

            try {
                // Gọi hàm thông minh thay vì gọi trực tiếp
                const data = await fetchSmart(`/search?q=${query}&filter=music_songs`);
                
                data.items.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'result-item';
                    // Hiển thị thêm thời lượng
                    const duration = formatDuration(item.duration);
                    div.innerHTML = `<div>${item.title}</div><div class="duration">${duration}</div>`;
                    div.onclick = () => playSong(item.url.split('v=')[1], item.title);
                    list.appendChild(div);
                });
            } catch (e) { 
                alert("Không thể kết nối tới bất kỳ server nào. Vui lòng kiểm tra mạng hoặc thử lại sau."); 
            }
            
            btn.innerText = originalText;
            btn.disabled = false;
        }

        async function playSong(videoId, title) {
            document.getElementById('player-controls').style.display = 'block';
            document.getElementById('nowPlaying').innerText = "Đang lấy link audio: " + title;
            
            try {
                const data = await fetchSmart(`/streams/${videoId}`);
                const audioStream = data.audioStreams.find(s => s.mimeType.includes('mp4') || s.mimeType.includes('webm'));
                
                if(audioStream) {
                    const player = document.getElementById('audioPlayer');
                    player.src = audioStream.url;
                    document.getElementById('nowPlaying').innerText = title;
                    player.play();
                    
                    // Cập nhật màn hình khóa
                    if ('mediaSession' in navigator) {
                        navigator.mediaSession.metadata = new MediaMetadata({
                            title: title, artist: "No-Ads Player",
                            artwork: [{ src: data.thumbnailUrl, sizes: '512x512', type: 'image/jpeg' }]
                        });
                    }
                } else { alert("Không tìm thấy luồng audio."); }
            } catch (e) { alert("Lỗi khi tải bài hát."); }
        }

        function formatDuration(seconds) {
            if(!seconds) return "";
            const min = Math.floor(seconds / 60);
            const sec = seconds % 60;
            return `${min}:${sec < 10 ? '0' : ''}${sec}`;
        }
    </script>
</body>
</html>