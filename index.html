<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Music Player V3 (Proxy)</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #000; color: #fff; margin: 0; }
        h2 { text-align: center; color: #ff0050; margin-bottom: 5px; }
        .status { font-size: 11px; text-align: center; color: #888; margin-bottom: 15px; }
        input { width: 100%; padding: 12px; margin-bottom: 10px; background: #222; border: 1px solid #333; color: white; border-radius: 20px; box-sizing: border-box; outline: none; }
        button { width: 100%; padding: 12px; background: #ff0050; border: none; color: white; font-weight: bold; border-radius: 20px; font-size: 16px; cursor: pointer; }
        .result-item { padding: 15px 0; border-bottom: 1px solid #222; display: flex; align-items: center; gap: 10px; cursor: pointer;}
        .result-img { width: 50px; height: 50px; border-radius: 4px; object-fit: cover; background: #333; }
        .result-info { flex: 1; }
        .result-title { font-size: 14px; font-weight: bold; margin-bottom: 3px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .result-sub { font-size: 12px; color: #aaa; }
        #player-controls { position: fixed; bottom: 0; left: 0; right: 0; background: #111; padding: 15px; border-top: 1px solid #333; z-index: 99; display: none; text-align: center; }
        audio { width: 100%; margin-top: 10px; outline: none; height: 40px; }
        #results { padding-bottom: 120px; }
    </style>
</head>
<body>
    <h2>Youtube Music V3</h2>
    <div class="status" id="statusMsg">Sử dụng kênh dẫn Proxy để vượt chặn</div>

    <input type="text" id="searchInput" placeholder="Tìm bài hát (VD: Lofi chill)...">
    <button onclick="startSearch()">TÌM KIẾM</button>
    <div id="results"></div>

    <div id="player-controls">
        <div id="nowPlaying" style="font-weight:bold; font-size: 14px; margin-bottom: 5px; color: #ff0050;">Đang tải...</div>
        <audio id="audioPlayer" controls loop autoplay></audio>
    </div>

    <script>
        // SỬ DỤNG PROXY ĐỂ VƯỢT LỖI CORS
        // Proxy này sẽ thay mặt bạn gọi đến server nhạc
        const PROXY_URL = "https://api.allorigins.win/raw?url=";
        
        // Danh sách server nhạc (Piped Instances)
        const SERVERS = [
            "https://pipedapi.kavin.rocks",
            "https://api.piped.privacydev.net",
            "https://pipedapi.drgns.space"
        ];
        
        let currentServerIndex = 0;

        async function getWithProxy(endpoint) {
            // Thử từng server trong danh sách
            for (let i = 0; i < SERVERS.length; i++) {
                // Tạo link đi vòng qua Proxy
                const targetUrl = SERVERS[i] + endpoint;
                const finalUrl = PROXY_URL + encodeURIComponent(targetUrl);
                
                document.getElementById('statusMsg').innerText = `Đang kết nối qua Proxy tới Server ${i+1}...`;
                
                try {
                    const res = await fetch(finalUrl);
                    if (res.ok) {
                        document.getElementById('statusMsg').innerText = `Đã kết nối thành công!`;
                        return await res.json();
                    }
                } catch (e) {
                    console.log(`Server ${i+1} lỗi, thử cái tiếp theo...`);
                }
            }
            throw new Error("Tất cả server đều bận");
        }

        async function startSearch() {
            const btn = document.querySelector('button');
            const query = document.getElementById('searchInput').value;
            if(!query) return;

            btn.innerText = "ĐANG QUÉT...";
            btn.disabled = true;
            document.getElementById('results').innerHTML = '';

            try {
                const data = await getWithProxy(`/search?q=${query}&filter=music_songs`);
                
                data.items.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'result-item';
                    
                    // Lấy link ảnh (nếu có lỗi thì dùng ảnh rỗng)
                    const thumb = item.thumbnailUrl || '';
                    
                    div.innerHTML = `
                        <img src="${thumb}" class="result-img" onerror="this.style.display='none'">
                        <div class="result-info">
                            <div class="result-title">${item.title}</div>
                            <div class="result-sub">${formatTime(item.duration)} • ${item.uploaderName}</div>
                        </div>
                    `;
                    
                    // Bấm vào thì phát nhạc
                    div.onclick = () => playMusic(item.url.split('v=')[1], item.title, thumb);
                    document.getElementById('results').appendChild(div);
                });
            } catch (e) {
                alert("Lỗi: Không thể kết nối server nhạc. Hãy thử lại sau vài phút.");
                document.getElementById('statusMsg').innerText = "Lỗi kết nối mạng/proxy.";
            }
            btn.innerText = "TÌM KIẾM";
            btn.disabled = false;
        }

        async function playMusic(id, title, thumb) {
            document.getElementById('player-controls').style.display = 'block';
            document.getElementById('nowPlaying').innerText = "Đang lấy file nhạc: " + title;
            
            try {
                const data = await getWithProxy(`/streams/${id}`);
                
                // Tìm file nhạc (m4a hoặc webm)
                const audio = data.audioStreams.find(s => s.mimeType.includes('mp4') || s.mimeType.includes('webm'));
                
                if (audio) {
                    const player = document.getElementById('audioPlayer');
                    player.src = audio.url;
                    player.play();
                    document.getElementById('nowPlaying').innerText = title;

                    // Hiển thị ở màn hình khóa
                    if ('mediaSession' in navigator) {
                        navigator.mediaSession.metadata = new MediaMetadata({
                            title: title,
                            artist: "Youtube Music V3",
                            artwork: [{ src: thumb, sizes: '512x512', type: 'image/jpeg' }]
                        });
                    }
                } else {
                    alert("Bài này bị lỗi dữ liệu, vui lòng chọn bài khác.");
                }
            } catch (e) {
                alert("Không tải được bài hát này. Thử bài khác nhé!");
            }
        }

        function formatTime(seconds) {
            if (!seconds) return "";
            const m = Math.floor(seconds / 60);
            const s = seconds % 60;
            return `${m}:${s < 10 ? '0'+s : s}`;
        }
    </script>
</body>
</html>