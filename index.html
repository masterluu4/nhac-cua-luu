<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Music Player V4 (Final)</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #000; color: #fff; margin: 0; }
        h2 { text-align: center; color: #0f0; margin-bottom: 5px; text-transform: uppercase; }
        .note { font-size: 11px; color: #666; text-align: center; margin-bottom: 15px; }
        
        input { width: 100%; padding: 15px; margin-bottom: 10px; background: #222; border: 1px solid #333; color: white; border-radius: 30px; outline: none; font-size: 16px; box-sizing: border-box;}
        button { width: 100%; padding: 15px; background: #0f0; border: none; color: black; font-weight: 900; border-radius: 30px; font-size: 16px; cursor: pointer; text-transform: uppercase; }
        button:active { transform: scale(0.98); }

        .item { padding: 15px 0; border-bottom: 1px solid #222; display: flex; align-items: center; gap: 15px; }
        .thumb { width: 60px; height: 60px; border-radius: 8px; background: #333; object-fit: cover; }
        .info { flex: 1; }
        .title { font-weight: bold; font-size: 14px; margin-bottom: 5px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .sub { font-size: 12px; color: #888; }
        
        #player { position: fixed; bottom: 0; left: 0; right: 0; background: #111; padding: 20px; border-top: 1px solid #333; text-align: center; display: none; z-index: 1000; }
        audio { width: 100%; height: 40px; margin-top: 10px; }
        #status { color: yellow; font-size: 12px; margin-top: 10px; font-style: italic; }
    </style>
</head>
<body>
    <h2>Music Player V4</h2>
    <div class="note">Server: Invidious • Proxy: IO</div>

    <input type="text" id="keyword" placeholder="Nhập tên bài hát...">
    <button onclick="search()">Tìm Kiếm</button>
    <div id="status"></div>
    <div id="list" style="padding-bottom: 150px; margin-top: 20px;"></div>

    <div id="player">
        <div id="song-name" style="font-weight:bold; color: #0f0; margin-bottom: 5px;"></div>
        <audio id="audio" controls autoplay loop></audio>
    </div>

    <script>
        // Sử dụng Proxy mạnh hơn để xuyên qua tường lửa
        const PROXY = "https://corsproxy.io/?";
        // Danh sách các server Invidious (khác với Piped)
        const HOSTS = [
            "https://inv.tux.pizza",
            "https://vid.puffyan.us",
            "https://invidious.drgns.space"
        ];

        let hostIndex = 0;

        function log(msg) { document.getElementById('status').innerText = msg; }

        async function search() {
            const query = document.getElementById('keyword').value;
            if(!query) return;
            
            log("Đang kết nối Server 1...");
            document.getElementById('list').innerHTML = "";
            
            // Thử lần lượt các server
            for (let i = 0; i < HOSTS.length; i++) {
                try {
                    // Gọi API tìm kiếm
                    const url = `${PROXY}${encodeURIComponent(HOSTS[i] + "/api/v1/search?q=" + query + "&type=video")}`;
                    const res = await fetch(url);
                    if(!res.ok) throw new Error("Lỗi mạng");
                    
                    const data = await res.json();
                    renderList(data, HOSTS[i]);
                    log(""); // Xóa thông báo lỗi
                    return; // Thành công thì thoát
                } catch (e) {
                    log(`Server ${i+1} bị chặn, đang đổi server...`);
                }
            }
            log("Thất bại: Mạng của bạn chặn tất cả Server. Hãy thử bật 1.1.1.1");
        }

        function renderList(data, currentHost) {
            const list = document.getElementById('list');
            data.forEach(item => {
                const div = document.createElement('div');
                div.className = 'item';
                div.innerHTML = `
                    <img class="thumb" src="${item.videoThumbnails[0].url}">
                    <div class="info">
                        <div class="title">${item.title}</div>
                        <div class="sub">${item.author}</div>
                    </div>
                `;
                // Khi bấm vào bài hát
                div.onclick = () => play(item.videoId, currentHost, item.title, item.videoThumbnails[0].url);
                list.appendChild(div);
            });
        }

        async function play(id, host, title, img) {
            document.getElementById('player').style.display = 'block';
            document.getElementById('song-name').innerText = "Đang tải: " + title;
            
            try {
                // Lấy link nhạc trực tiếp
                const url = `${PROXY}${encodeURIComponent(host + "/api/v1/videos/" + id)}`;
                const res = await fetch(url);
                const data = await res.json();
                
                // Tìm file audio (định dạng webm hoặc m4a)
                let audioUrl = "";
                // Ưu tiên adaptiveFormats (chất lượng cao hơn)
                const format = data.adaptiveFormats.find(f => f.type.includes("audio/webm"));
                if(format) {
                    audioUrl = format.url;
                } else {
                    // Nếu không có thì tìm format thường
                    audioUrl = data.formatStreams.find(f => f.type.includes("audio")).url;
                }

                if(audioUrl) {
                    const audio = document.getElementById('audio');
                    audio.src = audioUrl;
                    document.getElementById('song-name').innerText = title;
                    
                    // Cấu hình màn hình khóa
                    if ('mediaSession' in navigator) {
                        navigator.mediaSession.metadata = new MediaMetadata({
                            title: title, artist: "Music V4",
                            artwork: [{ src: img, sizes: '512x512', type: 'image/jpeg' }]
                        });
                    }
                }
            } catch (e) {
                alert("Không lấy được link nhạc. Bài hát này bị giới hạn.");
            }
        }
    </script>
</body>
</html>